schemaVersion: 2.2.0
metadata:
  name: workspace-test
attributes:
#  controller.devfile.io/storage-type: ephemeral
  pod-overrides:
    metadata:
      annotations:
        cluster-autoscaler.kubernetes.io/safe-to-evict: 'false'
      labels:
        devworkspace: 'true'
        archetype: wordpress
        servizio_ict: int-sa-0000


components:
  - name: wordpress-vol
    volume:
      size: 1G
  - name: mysql-vol
    volume:
      size: 1G

  - name: tools
    container:
      image: alm-repos.sogei.it/devfile/universal-developer-image:ubi8-4407fa4_v2.6.0
      volumeMounts:
        - name: wordpress-vol
          path: /var/www/html
      memoryLimit: 2G
      memoryRequest: 256Mi
      cpuLimit: 700m
      cpuRequest: 150m      
      mountSources: true

  - name: mysql
    container:
      image: docker.io/mysql:8
      endpoints:
        - name: mysql
          targetPort: 3306
          protocol: tcp
          exposure: internal
      volumeMounts:
        - name: mysql-vol
          path: "/var/lib/mysql"
      memoryLimit: 2G
      memoryRequest: 1G
      cpuLimit: 1000m
      cpuRequest: 250m
      mountSources: false
      env:
        - name: "MYSQL_USER"
          value: mysqluser
        - name: "MYSQL_PASSWORD"
          value: My0Good0Psw0
        - name: "MYSQL_DATABASE"
          value: wordpress
        - name: "MYSQL_ROOT_PASSWORD"
          value: My0Good0Psw0

  - name: wordpress
    container:
      # required a dedicated image to change the port from 80 to one bigger than 1000 in order to
      # enable the image to be executed as non root (ports < 1000 require privileged accounts)
      image: docker.io/cerbio/wordpress:6.3-php8.2-apache_amd
      endpoints:
        - exposure: public
          name: app
          protocol: http
          targetPort: 8080
          path: /
      volumeMounts:
        - name: wordpress-vol
          path: /var/www/html
      memoryLimit: 2G
      memoryRequest: 1G
      cpuLimit: 1000m
      cpuRequest: 250m      
      mountSources: true
      env:
        - name: WORDPRESS_DB_HOST
          value: 127.0.0.1
        - name: WORDPRESS_DB_USER
          value: mysqluser
        - name: WORDPRESS_DB_PASSWORD
          value:  My0Good0Psw0
        - name: WORDPRESS_DB_NAME
          value: wordpress


commands:
  - id: setup-environment
    exec:
      label: Task automatico
      component: tools
      workingDir: ${PROJECTS_ROOT}
      commandLine: |
        configure_git(){
          git config --global credential.helper 'cache --timeout 36000'
          git config --global init.defaultBranch main
        }
        configure_git

  - id: deploy-themes
    exec:
      label: Deploy themes
      component: tools
      workingDir: ${PROJECTS_ROOT}
      commandLine: |
        # copy themes nel wp-content
        cp -Rv ${PROJECT_SOURCE}/themes/* /var/www/html/wp-content/themes
  - id: deploy-plugins
    exec:
      label: Deploy plugins
      component: tools
      workingDir: ${PROJECTS_ROOT}
      commandLine: |
        # copy themes nel wp-content
        cp -Rv ${PROJECT_SOURCE}/plugins/* /var/www/html/wp-content/plugins

events:
  postStart:
    - setup-environment
